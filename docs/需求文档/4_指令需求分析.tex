\chapter{指令系统需求分析}

指令系统是硬件（CPU）对ucore唯一透明可见的接口，也因而成为在``运行ucore''之下的第二级需求。

在对ucore进行需求分析后可知，在指令系统这一层面，一共有46条需要实现的指令。各条指令的详细格式见附录。

本章包括如下几个部分：

\begin{enumerate}
    \item {\bf 概述}：对指令流水线的简要介绍
    \item {\bf 算术逻辑指令}：共22条，包括加减乘、与或非、移位等指令
    \item {\bf 分支跳转指令}：共10条，包括分支（B）与跳转（J）指令
    \item {\bf 访存指令}：共5条，包括读取（L）与写入（S）指令
    \item {\bf 移动指令}：共4条，包括对HI/LO寄存器的读写指令
    \item {\bf 陷入指令}：共1条，包括SYSCALL
    \item {\bf 特权指令}：共5条，包括对CP0的访问、异常返回及TLB异常时使用的指令
    \item {\bf 总结}：以上指令对硬件需求的扼要总结
\end{enumerate}

本章除概述与总结外，每节遵从以下介绍流程：

\begin{enumerate}
    \item {\bf 功能}：简要描述此类指令的功能
    \item {\bf 硬件需求}：为实现此类指令，对硬件的结构和功能需求
    \item {\bf 异常}：此类指令可能触发的异常，或对异常处理的影响
\end{enumerate}

\section{概述}

本次项目计划实现指令流水CPU。概括说来，每条指令被分为以下5个阶段，每个阶段由一个硬件单元执行：

\tablethreeL{名称}{代号}{功能}
    取指 & IF & 从指令存储器中读取指令 \\
    译码 & ID & 指令译码，同时读取寄存器 \\
    执行 & EX & 执行操作，或计算地址 \\
    访存 & MEM & 进行访存操作 \\
    回写 & WB & 将计算结果写入寄存器 \\
\tableend

以下文档内容中的``流水线''指的是这5个硬件单元构成的整体。它负责指令的执行，同时集成了对周边硬件单元的调度工作，在CPU中居于核心位置。

对流水线结构的详细分析见``CPU需求分析''一章。

\section{算术逻辑指令}

算术逻辑指令共22条，包括加减乘、与或非、移位等，总结如下：

\subsection{功能}

\tablethreeL{指令}{运算}{功能}
    ADDIU、ADDU & A + B & 无符号数加法 \\
    SUBU & A - B & 无符号数减法 \\
    MULT & A $\times$ B & 乘法 \\
    SLT、SLTI、SLTIU、SLTU & A < B & 符号数比较、无符号数比较 \\
    \midrule
    AND、ANDI & A and B  & 与 \\
    OR、ORI & A or B & 或 \\
    NOR & A nor B & 或非 \\
    XOR、XORI & A xor B & 异或 \\
    SLL、SLLV & A sll B & 逻辑左移 \\
    SRL、SRLV & A srl B & 逻辑右移 \\
    SRA、SRAV & A sra B & 算术右移 \\
    \midrule
    LUI & A = imm || $0^{16}$ & 加载立即数至寄存器 \\
\tableend

\subsection{硬件需求}

这部分对硬件的需求主要体现在ALU上，它位于流水线的第3部分（EX）。具体地，ALU需接受2个32位整数及相关控制信号作为输入，并以1个32位整数作为输出。控制信号决定了ALU执行的运算；
此外，运算结果应在WB阶段被写入寄存器。

特别地，乘法运算的结果是一个64位整数，因此需要HI/LO寄存器分别用于存储乘积的高、低32位，而不能存入通用寄存器。

算术逻辑运算指令对硬件的需求总结如下：

\begin{enumerate}
    \item {\bf 流水线}：能对算术运算指令进行解码识别。能读写通用寄存器。能计算2个32位整数作指定运算的结果，并产生一个32位整数作为输出。
    \item {\bf HI/LO}：当运算类型为乘法时，可以保存64位的乘法运算结果。
\end{enumerate}

% \tabletwoL{硬件单元}{用途}
%     ALU & 位于EX阶段，用于计算2个32位整数的运算结果 \\
%     HI/LO寄存器 & 用于存储乘积 \\
% \tableend

\subsection{异常}

% TODO：有溢出异常么？
无。

\section{分支跳转指令}

分支跳转指令共10条，包括分支（Branch）与跳转（Jump）2类指令，总结如下：

\subsection{功能}

\tabletwoL{指令}{功能}
    BEQ、BNE、BGEZ、BGTZ、BLEZ、BLTZ & 分支指令，用于有条件跳转。 \\
                                    & 条件包括$==, !=, \geq, >, \leq, <$。 \\
    \midrule
    J、JR & 跳转指令，用于无条件跳转； \\
    JAL、JALR & 同上，但会使用寄存器（常为R[31]）预先保存此前的PC值 \\
\tableend

\subsection{硬件需求}

这部分对硬件的需求主要集中于流水线的设计。此外，由于延迟槽指令的存在，异常处理需增加一些特殊的判断逻辑，详细分析见``异常''部分。

跳转指令对硬件的需求主要集中于流水线，总结如下：

\begin{enumerate}
    \item {\bf 流水线}：能对分支跳转指令进行解码识别。能读写通用寄存器。此外能改变指令的执行顺序并判断状态：
    \begin{itemize}
        \item {\bf PC}：可以在每个周期取指时，根据``是否需要跳转''这一控制信号，对PC的下一次取指做出判断：如需跳转，则将PC赋值为跳转目标地址；否则PC照常自增4。
        \item {\bf 延迟槽}：流水线中各个硬件单元可以确定当前正在执行的指令是否在延迟槽中。更具体的分析见``异常部分''。
    \end{itemize}
\end{enumerate}

% \begin{enumerate}
%     \item {\bf 取指}：取指阶段需根据控制信号，对PC的下一次取指做出判断：如需跳转，则将PC赋值为跳转目标地址；否则PC照常自增4。
%     \item {\bf 译码}：译码阶段需1) 识别分支跳转指令，2) 向取指模块提供与跳转相关的控制信号，3) 向流水线的后续阶段提供当前指令是否为延迟指令的信息，便于异常处理。
%     \item {\bf 执行}：执行阶段需对JAL、JALR指令，将其返回地址（也即旧的PC值）作为要写入的寄存器值传入流水线的后续阶段。
%     \item {\bf 访存}：无。
%     \item {\bf 回写}：
% \end{enumerate}

\subsection{异常}

分支跳转指令本身不会产生异常。但由于分支跳转指令引入了\emph{延迟槽指令}，这会对异常处理带来额外的判断逻辑。

\image[4in]{branch_delay_slot}{延迟槽指令}

\paragraph{延迟槽指令} 我们规定分支指令后面的指令位置为\emph{分支延迟槽}，其中的指令称为\emph{延迟指令}。由于在计算分支目标地址时，延迟指令已经进入流水线，因而无论跳转发生与否，
它都必然被执行。

\paragraph{异常处理相关} 具体地，在异常处理时，需将异常发生时的指令地址（PC值）存入CP0的EPC寄存器中，以便异常处理结束后返回该地址继续执行。然而如果触发异常的指令为延迟槽指令，则需要
将EPC寄存器的值置为PC-4，而非PC的当前值。这是因为在延迟槽指令之前可能已经发生了跳转，因而其后需继续执行的指令序列应位于跳转的目标地址，而非延迟槽指令之后。

因此，流水线中的各个硬件单元需能够确定当前指令是否位于延迟槽，以便在发生异常时可以向EPC寄存器中保存正确的地址。

\section{访存指令}

访存指令共5条，包括读取（Load）与写入（Store）2类指令，总结如下：

\subsection{功能}

\tabletwoL{指令}{功能}
    LB、LBU & 读内存中的一个字节（8位） \\
    LW & 读内存中的一个字（32位） \\
    \midrule
    SB & 写内存中第一个字节（8位） \\
    SW & 写内存中的一个字（32位） \\
\tableend

\subsection{硬件需求}

这一部分对硬件的需求包括3大部分。首先，流水线需要对访存指令进行译码，如果是读，则需要读取相应的寄存器；否则为写，需要将结果写入寄存器中；其次，需要在流水线框架之上集成其他外设，
包括在ucore部分已经有所介绍的ROM、RAM、FLASH、串口、VGA等；最后，为了在指令向CPU提供的虚拟地址与外设的物理地址之间实现衔接，硬件需要通过MMU与TLB进行地址映射。

访存指令对硬件的主要需求可以总结如下：

\begin{enumerate}
    \item {\bf 流水线}：能对访存指令进行解码识别。能读写通用寄存器。能通过MMU以统一的接口访问外设。能执行TLB异常处理流程。
    \item {\bf 外设}：能在流水线的框架之上集成外设，实现其读写操作。
    \item {\bf MMU}：能将指令提供的虚拟地址映射到对应的外设，实现地址转换。
    \item {\bf CP0}：能提供寄存器记录可能的异常信息。
\end{enumerate}

\subsection{异常}

在ucore需求分析部分得出的异常列表中，访存指令可能触发其中的TLB MISS异常、地址未对齐异常。其中，TLB MISS异常为硬件需要实现的异常。

\section{移动指令}

移动指令共4条，主要包括对HI/LO寄存器的读写指令。总结如下：

\subsection{功能}

\tabletwoL{指令}{功能}
    MFHI、MFLO & 读HI/LO寄存器 \\
    MTHI、MTLO & 写HI/LO寄存器 \\
\tableend

\subsection{硬件需求}

这一部分对硬件的需求集中于对HI/LO寄存器的访问。具体地，流水线需要在识别出这些指令的类型后，实现与HI/LO寄存器的读写交互。HI/LO寄存器则需要实现相应的访问接口以支持读写。

总结如下：

\begin{enumerate}
    \item {\bf 流水线}：能对移动指令进行解码识别。能读写通用寄存器。能访问HI/LO寄存器的读写接口。
    \item {\bf HI/LO}：能提供接口支持读写操作。
\end{enumerate}

\subsection{异常}

无。

\section{陷入指令}

陷入指令共包括1条指令SYSCALL。

\subsection{功能}

\tabletwoL{指令}{功能}
    SYSCALL & 系统调用指令，操统执行此指令时，陷入内核态并调用相应异常处理代码 \\
\tableend

\subsection{硬件需求}

这一部分对硬件的需求主要集中于异常处理：此条指令会触发SYSCALL异常，因而硬件需要首先在流水线阶段识别该指令，然后依通用异常处理流程将异常原因等写入CP0相关寄存器中。

SYSCALL指令对硬件的主要需求可以总结如下：

\begin{enumerate}
    \item {\bf 流水线}：能对SYSCALL指令进行解码识别。能执行通用异常处理流程。
    \item {\bf CP0}：能提供寄存器记录异常信息。
\end{enumerate}

\subsection{异常}

触发SYSCALL异常。

\section{特权指令}

特权指令共5条，包括对CP0的访问、TLB的维护、异常的返回等功能，总结如下：

\subsection{功能}

\tabletwoL{指令}{功能}
    MFC0、MTC0 & 读写协处理器CP0 \\
    TLBWI、TLBWR & 写TLB表项 \\
    ERET & 异常返回：取消异常标志并返回受害指令地址 \\
\tableend

\subsection{硬件需求}

这一部分对硬件的需求较而杂。首先，这类指令之所以称为特权指令，是因为它们只能在内核态被调用，其功能多与异常处理、TLB维护（多用于TLB异常处理）等相关。其次，无论是TLB的维护，还是异常的处理，
都需要流水线、MMU、CP0等多个硬件单元的协同配合。

这里仅简要总结这部分指令对硬件的需求：

\begin{enumerate}
    \item {\bf 流水线}：能对各特权指令进行解码识别。能读写通用寄存器。能执行通用异常、TLB异常处理流程。
    \item {\bf MMU}：能写入TLB表项。
    \item {\bf CP0}：能提供寄存器记录可能的异常信息。
\end{enumerate}

\subsection{异常}

% TODO: Please check
无。

\section{总结}

% TODO: Please check

总体来说，指令系统对硬件的需求可以统一总结如下：

\tablethreeL{所属部分}{硬件单元}{需求}
    CPU & {\bf 流水线} & {\bf 取指（IF）}：能每周期取得下一条指令的地址。\\
        &       & {\bf 译码（ID）}：能对不同的指令解码识别。能读写通用寄存器。\\
        &       & {\bf 执行（EX）}：能实现ALU提供的运算功能。能从CP0、HI/LO读出数据。 \\
        &       & {\bf 访存（MEM）}：能通过MMU提供的接口对外部设备进行读写访问。\\
        &       & {\bf 回写（WB）}：能将数据写入通用寄存器或CP0、HI/LO寄存器。\\
        &       & 各个部分能协同实现通用异常、TLB异常处理流程。\\

    \cline{2-3}

    & {\bf 寄存器堆} & 能提供32个通用寄存器用于实现指令中操作数的传递。能提供读写接口。 \\

    & {\bf HI/LO寄存器} & 能保存乘法运算的结果（64位整数）。能提供读写接口。\\

    \cline{2-3}

    & {\bf CP0} & 能提供不同寄存器以记录异常信息的不同字段。能提供读写接口。 \\

    \cline{2-3}

    & {\bf MMU} & 能实现ucore所需的地址映射功能。能实现TLB的表项写入操作。\\

    \midrule

    外设 & {\bf 外设} & 能以黑盒方式使用外设，将其集成到MMU之下，提供读写接口。 \\

\tableend
